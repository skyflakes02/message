from argparse import ArgumentParser
from dataclasses import dataclass
from random import Random, getrandbits
from typing import Final

import pyxel

import pyxelgrid as pg
import pipelib as pl


TITLE: Final[str] = "Pipe Dream"
FPS: Final[int] = 25


@dataclass
class CellState:
    pipe_type: int  # type of pipe
    rotation: int   # rotation of the pipe
    connected: bool  # whether the pipe is connected to the network


class PipeGame(pg.PyxelGrid[CellState]):
    def __init__(self, settings: pl.DifficultySettings, seed: int) -> None:
        self.settings = settings
        self.seed = seed
        self.rand = Random(seed)

        # Initialize the grid with empty cells
        super().__init__(settings.r, settings.c, dim=pl.DIM)
        self.grid = [[CellState(0, 0, False) for _ in range(settings.c)] for _ in range(settings.r)]

    def init(self) -> None:
        pyxel.mouse(True)
        pyxel.load(pl.PIPE_RESOURCE_PATH)
        pyxel.rseed(self.seed)

        # Initialize pipes randomly in the grid
        for i in range(self.settings.r):
            for j in range(self.settings.c):
                pipe_type = self.rand.randint(1, 4)  # Assuming 4 types of pipes
                rotation = self.rand.randint(0, 3)  # 4 possible rotations (0, 90, 180, 270 degrees)
                self.grid[i][j] = CellState(pipe_type, rotation, False)

    def update(self) -> None:
        if pyxel.btnp(pyxel.MOUSE_BUTTON_LEFT):
            x, y = pyxel.mouse_x, pyxel.mouse_y
            i, j = self.mouse_cell()
            if 0 <= i < self.settings.r and 0 <= j < self.settings.c:
                self.grid[i][j].rotation = (self.grid[i][j].rotation + 1) % 4

        # TODO: Implement game logic to check connections and update cell states

    def draw_cell(self, i: int, j: int, x: int, y: int) -> None:
        cell = self.grid[i][j]
        u = cell.pipe_type * pl.DIM
        v = cell.rotation * pl.DIM
        pyxel.blt(x, y, 0, u, v, pl.DIM, pl.DIM)

    def pre_draw_grid(self) -> None:
        pyxel.cls(0)  # Clear the screen with black

    def post_draw_grid(self) -> None:
    # Draw the elapsed time
    elapsed_seconds = (pyxel.frame_count - self.start_time) // FPS
    pyxel.text(5, 5, f"Time: {elapsed_seconds}s", 7)

    # Draw the "N = New Game" text
    pyxel.text(pyxel.width - 60, 10, "N = New Game", 7)


def main():
    parser = ArgumentParser(description=f"Run the '{TITLE}' game.")

    parser.add_argument('-d', '--difficulty', default='easy',
        help=f"the game difficulty. must be one of: {', '.join(pl.DIFFICULTY_SETTINGS.keys())} (default: %(default)s)")
    parser.add_argument('-s', '--seed', type=int, default=None,
        help="the seed for the random number generator. (default: based on system time)")

    args = parser.parse_args()

    if (seed := args.seed) is None:
        seed = getrandbits(31)

    if args.difficulty not in pl.DIFFICULTY_SETTINGS:
        raise ValueError(f"Unknown difficulty: {args.difficulty}")

    PipeGame(settings=pl.DIFFICULTY_SETTINGS[args.difficulty], seed=seed).run(title=TITLE, fps=FPS)


if __name__ == '__main__':
    main()
